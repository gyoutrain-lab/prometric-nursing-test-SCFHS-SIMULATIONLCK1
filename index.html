<script>
/* ================= CONFIG ================= */
const PROVIDER_CODE = "GYOUTRAIN-APPROVED";
const EXAM_TIME = 60 * 60;

/* ================= STATE ================= */
let timeLeft = EXAM_TIME;
let timerInterval;
let current = 0;

/* ================= QUESTIONS ================= */
const questions = [
{
q: "A patient develops hypotension, wheezing, and tachycardia immediately after IV antibiotic administration. What is the PRIORITY nursing action?",
options: [
"Stop the infusion immediately",
"Administer oral antihistamine",
"Document the adverse reaction",
"Reduce the infusion rate"
],
answer: 0,
rationales: [
"Correct. This is acute anaphylaxis. Stop antigen exposure immediately.",
"Incorrect. Oral antihistamines are too slow in anaphylaxis (NCLEX trap).",
"Incorrect. Documentation is secondary in emergencies (STR priority trap).",
"Incorrect. Slowing the infusion still exposes the patient to the allergen."
]
}
];

/* ================= LOGIC ================= */
function register() {
const n = name.value.trim();
const u = uid.value.trim();
const e = email.value.trim();

if (!n || !u || !e) {
alert("All fields are required.");
return;
}

if (localStorage.getItem("SCFHS_LOCKED")) {
document.getElementById("registerScreen").classList.add("hidden");
document.getElementById("lockedScreen").classList.remove("hidden");
return;
}

startExam();
}

function unlockExam() {
if (approvalCode.value.trim() !== PROVIDER_CODE) {
alert("Invalid approval code.");
return;
}
localStorage.removeItem("SCFHS_LOCKED");
document.getElementById("lockedScreen").classList.add("hidden");
startExam();
}

function startExam() {
document.getElementById("registerScreen").classList.add("hidden");
document.getElementById("examScreen").classList.remove("hidden");
document.getElementById("timer").classList.remove("hidden");
startTimer();
loadQuestion();
}

function startTimer() {
timerInterval = setInterval(() => {
timeLeft--;
let m = Math.floor(timeLeft / 60);
let s = timeLeft % 60;
timer.innerText = `${m}:${s.toString().padStart(2,"0")}`;
if (timeLeft <= 0) endExam();
}, 1000);
}

function loadQuestion() {
let q = questions[current];
questionText.innerText = q.q;
options.innerHTML = "";
rationaleBox.innerHTML = "";
nextBtn.classList.add("hidden");

q.options.forEach((o,i)=>{
options.innerHTML += `
<div class="option">
<input type="radio" name="opt" value="${i}"> ${o}
</div>`;
});
}

function submitAnswer() {
let selected = document.querySelector('input[name="opt"]:checked');
if (!selected) return alert("Select an answer.");

let idx = selected.value;
let q = questions[current];

rationaleBox.innerHTML =
idx == q.answer
? `<div class="rationale correct">${q.rationales[idx]}</div>`
: `<div class="rationale incorrect">${q.rationales[idx]}</div>`;

nextBtn.classList.remove("hidden");
}

function nextQuestion() {
current++;
if (current >= questions.length) endExam();
else loadQuestion();
}

function endExam() {
clearInterval(timerInterval);
localStorage.setItem("SCFHS_LOCKED", true);
document.getElementById("examScreen").classList.add("hidden");
document.getElementById("timer").classList.add("hidden");
document.getElementById("endScreen").classList.remove("hidden");
}

/* ===== DEV RESET (optional, remove in production) ===== */
// localStorage.removeItem("SCFHS_LOCKED");
</script>
